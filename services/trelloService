
import { WorkshopData, Vehicle, Stage } from '../types';

// Estas variáveis devem ser configuradas no painel do Vercel
const API_KEY = (import.meta as any).env?.VITE_TRELLO_API_KEY || '';
const TOKEN = (import.meta as any).env?.VITE_TRELLO_TOKEN || '';
const BOARD_ID = (import.meta as any).env?.VITE_TRELLO_BOARD_ID || '';

export const fetchWorkshopData = async (): Promise<WorkshopData> => {
  if (!API_KEY || !TOKEN || !BOARD_ID) {
    console.warn("Trello API credentials missing. Check Environment Variables.");
    return { boardName: "Configuração Pendente", vehicles: [] };
  }

  try {
    // 1. Buscar as Listas (que são os Status/Etapas)
    const listsRes = await fetch(`https://api.trello.com/1/boards/${BOARD_ID}/lists?key=${API_KEY}&token=${TOKEN}`);
    const lists = await listsRes.json();

    // 2. Buscar os Cartões (que são os Veículos)
    const cardsRes = await fetch(`https://api.trello.com/1/boards/${BOARD_ID}/cards?key=${API_KEY}&token=${TOKEN}`);
    const cards = await cardsRes.json();

    // Mapear listas para facilitar a busca por ID
    const listMap = lists.reduce((acc: any, list: any) => {
      acc[list.id] = list.name;
      return acc;
    }, {});

    const vehicles: Vehicle[] = cards.map((card: any) => {
      // Espera o formato do título: "Modelo - Placa - Cliente"
      const parts = card.name.split('-').map((p: string) => p.trim());
      
      return {
        id: card.id,
        model: parts[0] || 'Veículo sem Nome',
        plate: parts[1] || '---',
        client: parts[2] || 'Cliente não informado',
        stage: (listMap[card.idList] || 'Aguardando Avaliação') as Stage,
        deliveryDate: card.due ? new Date(card.due).toLocaleDateString('pt-BR') : 'Sem data',
        mechanic: card.labels?.[0]?.name || 'TBD', // Usa a primeira etiqueta como mecânico
        lastActivity: new Date(card.dateLastActivity).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
      };
    });

    return {
      boardName: "Gestão de Pátio Rei do ABS",
      vehicles
    };
  } catch (error) {
    console.error("Erro ao buscar dados do Trello:", error);
    throw error;
  }
};
